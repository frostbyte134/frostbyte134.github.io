---
layout: post
title:  "IFKAKAO 2022"
date:   2022-12-07 07:00:05 +0800
categories: coding
use_math: true
tags: coding 
---

대기타다가 시간이 남아서 좀 봄..ㅎㅎ

이제 자유네 ㅡㅡㅋ MERN 빨리 보자....

### 장애회고
별 게 없다..기보단 다 이미 아는내용인 듯. 사내회고때 좀 더 말해주려나..
- 정족수 의존적인 것들 -> 삼중화 필수
- mysql은 failover해주는 데몬이 문제였다 - 어떤 식으로 failover되는지 모르는데..세컨더리에서 알아서 primary로 승격 못하나? mysql 호스트의 a레코드쪽, vip역할의 무언가도 다운됐던 듯?
- 톡서버 - 레디스만 이중화 안됐던 것도 특이하긴 함. 굳이 시나리오를 써 보자면 레디스를 통해 서로 의존적인 것들 중 일부만 이중화되서 전부 다 기존 레디스를 바라볼 수 밖에 없었던 듯?
- 지나치게 사소한 순단에도 failover가 일어나는 것을 막는 로직이 오히려 방해가 되었다 -> 어렵지....

앱레이어쪽은 좀 더 보자

### 카카오톡 메시징 지표 이상 감지 시스템의 개선사례
<a href="https://if.kakao.com/2022/session/27" target="_blank">https://if.kakao.com/2022/session/27</a>

말풍선 기능이 안됨 (슬랙 이모지같은 그거)
- 우리도 디비 쿼리 수도 모니터링해야할 것 같음. 이거 추가 건의해봐야...?
    - 스테이지에서만 보면 되나? 그건 아닐 듯
- 수천개 지표? ㄷㄷ
- 임계치 설정 = 개발자의 이해도 필요 (ㅇㄱㄹㅇ ㅋㅋ)
    - 비즈니스로직, 인프라 변경 등에 취약
- 과거 비교 방법
    - 여러 특이사항 (장애 등) 많음
- 시계열 모델 이상탐지
    - 평일-휴일이 다름, fluctuation (우리도 그렇긴 함)
- 그라파나 데이터소스에서 학습한다고 함
    - 그라파나 커스텀쿼리로 데이터 전달
    - 만든거 그라파나 보니까 우리꺼랑 비슷 (위아래 밴드). 역시 피팅이나 얼럿 이해를 위해선 visualization이 중요한 듯
- `Prophet` (주기성, 휴일, 추세성 등 포함가능) - 함 써 볼까...
    - 아직은 구현된 상황은 아니지만??? ㅡㅡㅋ
    - 예정입니다 ㅡ,.ㅡ
    - 그라파나의 어노테이션으로 장애당시 지표 등은 제외한다고 함

### 카카오톡 메시징 시스템 재건축 이야기
C++을 코틀린으로? 왜지?
4년동안 진행중이라고 함 ㄷㄷ

<img src="{{site.url}}/images/coding/talkserver.jpg">  

TPS 50만, 평균 4천만개 세션 ㄷㄷ
- 월드컵중 = 초당 600만? ㄷㄷㄷ
- HTTP 대신 자체 프로토콜 사용??? ㄷㄷ

구조
- 연결설정등을 받아오는 설정서버
- 메시지 수발신을 위한 플래시구조(?)의 릴레이 서버
- 업로드케시
- 메시지저장, 채팅방 관리용 비즈니스 서버

앞단 = C++, 뒤쪽 비즈니스로직 = 자바 (10년전부터)
- epoll기반 비동기 입출력, 쓰레드별로 미리 메모리버퍼 할당 -> 대당 50만개의 세션 관리 가능

10년 뒤에는?
- 커스텀 vs 양산 = 양산이 표준화된 규격등으로 유지보수/확장이 용이
- 현재 앞단은 커스텀 (직접 개발한 프로토콜, 수많은 매크로, 강결합)
    - 버그 하나 생기면 난리남 (low cohesion, high coupling)
- 유닛테스트 커버리지가 낮음
- 통합테스트 - 케이스는 많지만, 파이썬을 통한 구성, 커스텀?
- 배포시스템 - 파이썬 구성 - 실수 유발 쉬움
- 인적 불균형 - C++개발자 구인난

뒷단 자바는?
- 배포는 jenkins, 유닛으ㅜㄴ junit, BDD?를 활용한 로컬테스트?
- netty with epoll

재건축 1 - 영향이 적은것 부터
1. private api
    - 사내서비스 연동용
    - 자체프로토콜 사용 - 사내서비스에서도 여기에 의존성 생김. 문서화도 잘 안됨
    - http지원, asciidog? 으로 문서화, k8s + argocd배포 
    - 한번에 교채하지는 못헀고, 프록시 (? 블루그린같은게 아니고?)로 먼저 끼워넣고 이후 완전교채
2. 세션 서버
    - 릴레이 서버에 연결된 클라들이 어떤서버에 연결되있는지 정보를 저장
    - 인메모리, 모듈러 해싱? - 앱서버 대신 레디스에 저장

재건출 2 - 고성능 앱 (500k sessions)
- JVM기반 언어 - GC때문에 (stop the world) - ZGC사용?
- 코틀린 전면도입: 간결, 가독성 높은 코드?
- 현재는 쓰레드풀을 이용한 비동기 - 조만간 코루틴 사용 예정
- 한대씩 순차적용 (블랙박스처럼. 기존에서 파드 하나씩 교체가능)
- 성능이 받쳐줄까? - 지속적인 부하테스트 (이건 뭐 사람이 하는 수밖에 없는 듯...)

### TODO - backend
https://if.kakao.com/2022/session/28
https://if.kakao.com/2022/session/37 - 제이꺼랑 같이보면 좋을 듯. 제이껀 언제 퍼블리싱되나 ㅎㅎ
https://if.kakao.com/2022/session/32 - 캐시 무중단? 어떤게 어려웠는지 보면 좋을 듯
https://if.kakao.com/2022/session/25 - 광고 필터 - ES를 못 쓴 이유? 시간이 남으면?



https://if.kakao.com/2022/session/59 무슨 내용이지 ㄷㄷ


https://if.kakao.com/2022/session/73 흠

### 알림 서비스로 시작하는 서버 개발 (카뱅)
[https://www.youtube.com/watch?v=CmTO68I2HSc](https://www.youtube.com/watch?v=CmTO68I2HSc)

사용자에게 가는 알림서비스 이야기인 듯
